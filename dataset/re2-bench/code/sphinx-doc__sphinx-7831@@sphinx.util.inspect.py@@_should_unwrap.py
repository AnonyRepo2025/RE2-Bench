import builtins
import contextlib
import enum
import inspect
import re
import sys
import types
import typing
import warnings
from functools import partial, partialmethod
from inspect import (  # NOQA
    Parameter, isclass, ismethod, ismethoddescriptor, ismodule
)
from io import StringIO
from typing import Any, Callable, Mapping, List, Optional, Tuple
from typing import cast
from sphinx.deprecation import RemovedInSphinx40Warning, RemovedInSphinx50Warning
from sphinx.pycode.ast import ast  # for py35-37
from sphinx.pycode.ast import unparse as ast_unparse
from sphinx.util import logging
from sphinx.util.typing import stringify as stringify_annotation
from types import (
        ClassMethodDescriptorType,
        MethodDescriptorType,
        WrapperDescriptorType
    )
from functools import singledispatchmethod  # type: ignore

logger = logging.getLogger(__name__)
memory_address_re = re.compile(r' at 0x[0-9a-f]{8,16}(?=>)', re.IGNORECASE)

def _should_unwrap(subject: Callable) -> bool:
    """Check the function should be unwrapped on getting signature."""
    if (safe_getattr(subject, '__globals__', None) and
            subject.__globals__.get('__name__') == 'contextlib' and  # type: ignore
            subject.__globals__.get('__file__') == contextlib.__file__):  # type: ignore
        # contextmanger should be unwrapped
        return True

    return False
